# 系统部署文档

## 目录

1. [环境准备](#环境准备)
2. [开发环境部署](#开发环境部署)
3. [生产环境部署](#生产环境部署)
4. [Docker部署](#docker部署)
5. [常见问题](#常见问题)

---

## 环境准备

### 服务器要求

**最低配置：**
- CPU: 2核
- 内存: 4GB
- 硬盘: 50GB
- 操作系统: Linux (CentOS 7+/Ubuntu 18.04+) 或 Windows Server 2016+

**推荐配置：**
- CPU: 4核
- 内存: 8GB
- 硬盘: 100GB
- 操作系统: Linux (CentOS 7+/Ubuntu 18.04+)

### 软件环境

**必需软件：**
- JDK 1.8+
- MySQL 8.0+
- Redis 5.0+
- Node.js 16+
- Maven 3.6+

**可选软件：**
- Nginx 1.18+ (用于反向代理和静态资源服务)
- Docker 20.10+ (用于容器化部署)
- Docker Compose 1.29+ (用于容器编排)

---

## 开发环境部署

### 1. 安装基础软件

#### 1.1 安装 JDK

**Windows:**
1. 下载 JDK 1.8 安装包
2. 安装并配置环境变量 `JAVA_HOME`
3. 验证安装：`java -version`

**Linux:**
```bash
# CentOS
sudo yum install java-1.8.0-openjdk-devel

# Ubuntu
sudo apt-get install openjdk-8-jdk

# 验证安装
java -version
```

#### 1.2 安装 MySQL

**Windows:**
1. 下载 MySQL 8.0 安装包
2. 安装并设置 root 密码
3. 启动 MySQL 服务

**Linux:**
```bash
# CentOS
sudo yum install mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld

# Ubuntu
sudo apt-get install mysql-server
sudo systemctl start mysql
sudo systemctl enable mysql

# 设置 root 密码
sudo mysql_secure_installation
```

#### 1.3 安装 Redis

**Windows:**
1. 下载 Redis for Windows
2. 解压并启动 redis-server.exe

**Linux:**
```bash
# CentOS
sudo yum install redis
sudo systemctl start redis
sudo systemctl enable redis

# Ubuntu
sudo apt-get install redis-server
sudo systemctl start redis
sudo systemctl enable redis

# 验证安装
redis-cli ping
```

#### 1.4 安装 Node.js

**Windows:**
1. 下载 Node.js 16+ 安装包
2. 安装并验证：`node -v` 和 `npm -v`

**Linux:**
```bash
# 使用 NodeSource 仓库安装
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs

# 或使用 nvm 安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 16
nvm use 16

# 验证安装
node -v
npm -v
```

#### 1.5 安装 Maven

**Windows:**
1. 下载 Maven 3.6+ 安装包
2. 解压并配置环境变量 `MAVEN_HOME`
3. 验证安装：`mvn -v`

**Linux:**
```bash
# CentOS
sudo yum install maven

# Ubuntu
sudo apt-get install maven

# 验证安装
mvn -v
```

### 2. 数据库初始化

#### 2.1 创建数据库

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE base_system DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户并授权（可选）
CREATE USER 'base_user'@'%' IDENTIFIED BY 'base_password';
GRANT ALL PRIVILEGES ON base_system.* TO 'base_user'@'%';
FLUSH PRIVILEGES;

# 退出
exit;
```

#### 2.2 导入数据库脚本

```bash
# 导入表结构
mysql -u root -p base_system < backend/src/main/resources/db/schema.sql

# 导入初始数据
mysql -u root -p base_system < backend/src/main/resources/db/data.sql
```

### 3. 后端部署

#### 3.1 修改配置文件

编辑 `backend/src/main/resources/application-dev.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/base_system?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: your_mysql_password

  redis:
    host: localhost
    port: 6379
    password: # 如果 Redis 设置了密码，在这里填写
    database: 0

# 文件上传路径
file:
  upload:
    path: D:/upload/  # Windows 路径
    # path: /data/upload/  # Linux 路径
```

#### 3.2 编译打包

```bash
# 进入后端目录
cd backend

# 清理并打包
mvn clean package -DskipTests

# 打包成功后，jar 包位于 target/base-backend-1.0.0.jar
```

#### 3.3 启动后端服务

**方式一：使用 Maven 启动（开发环境）**
```bash
cd backend
mvn spring-boot:run
```

**方式二：使用 jar 包启动**
```bash
cd backend/target
java -jar base-backend-1.0.0.jar

# 指定配置文件
java -jar base-backend-1.0.0.jar --spring.profiles.active=dev

# 后台运行
nohup java -jar base-backend-1.0.0.jar > app.log 2>&1 &
```

**验证启动：**
- 访问 `http://localhost:8080/doc.html` 查看 API 文档
- 访问 `http://localhost:8080/auth/captcha` 获取验证码

### 4. 前端部署

#### 4.1 安装依赖

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 如果安装慢，可以使用淘宝镜像
npm install --registry=https://registry.npmmirror.com
```

#### 4.2 修改配置文件

编辑 `frontend/vite.config.js`：

```javascript
export default defineConfig({
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',  // 后端地址
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})
```

#### 4.3 启动前端服务

```bash
cd frontend

# 开发模式启动
npm run dev

# 访问 http://localhost:3000
```

---

## 生产环境部署

### 1. 后端生产部署

#### 1.1 修改生产配置

编辑 `backend/src/main/resources/application-prod.yml`：

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://your_mysql_host:3306/base_system?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: base_user
    password: your_strong_password

  redis:
    host: your_redis_host
    port: 6379
    password: your_redis_password
    database: 0

# JWT 配置
jwt:
  secret: your_production_jwt_secret_key_at_least_32_characters_long
  expiration: 86400000  # 24小时

# 文件上传路径
file:
  upload:
    path: /data/upload/
    prefix: /upload
    max-size: 10485760  # 10MB

# 日志配置
logging:
  level:
    root: INFO
    com.base: INFO
  file:
    name: /var/log/base-system/app.log
    max-size: 100MB
    max-history: 30
```

#### 1.2 编译打包

```bash
cd backend

# 使用生产配置打包
mvn clean package -DskipTests -Pprod

# 打包成功后，jar 包位于 target/base-backend-1.0.0.jar
```

#### 1.3 创建系统服务（Linux）

创建 systemd 服务文件 `/etc/systemd/system/base-backend.service`：

```ini
[Unit]
Description=Base System Backend Service
After=network.target mysql.service redis.service

[Service]
Type=simple
User=www
Group=www
WorkingDirectory=/opt/base-system/backend
ExecStart=/usr/bin/java -jar -Xms512m -Xmx2g -Dspring.profiles.active=prod /opt/base-system/backend/base-backend-1.0.0.jar
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
# 重新加载 systemd 配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start base-backend

# 设置开机自启
sudo systemctl enable base-backend

# 查看服务状态
sudo systemctl status base-backend

# 查看日志
sudo journalctl -u base-backend -f
```

### 2. 前端生产部署

#### 2.1 修改生产配置

编辑 `frontend/.env.production`：

```env
# API 基础路径
VITE_API_BASE_URL=http://your_domain.com/api

# 应用标题
VITE_APP_TITLE=权限管理系统
```

#### 2.2 构建生产包

```bash
cd frontend

# 构建生产包
npm run build

# 构建成功后，静态文件位于 dist 目录
```

#### 2.3 使用 Nginx 部署

**安装 Nginx：**

```bash
# CentOS
sudo yum install nginx

# Ubuntu
sudo apt-get install nginx

# 启动 Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

**配置 Nginx：**

创建配置文件 `/etc/nginx/conf.d/base-system.conf`：

```nginx
server {
    listen 80;
    server_name your_domain.com;

    # 前端静态文件
    location / {
        root /opt/base-system/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 文件上传目录
    location /upload/ {
        alias /data/upload/;
        expires 30d;
        access_log off;
    }

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;

    # 日志
    access_log /var/log/nginx/base-system-access.log;
    error_log /var/log/nginx/base-system-error.log;
}
```

**部署静态文件：**

```bash
# 创建部署目录
sudo mkdir -p /opt/base-system/frontend

# 复制构建文件
sudo cp -r frontend/dist/* /opt/base-system/frontend/

# 设置权限
sudo chown -R www:www /opt/base-system/frontend
```

**重启 Nginx：**

```bash
# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 3. HTTPS 配置（可选）

#### 3.1 申请 SSL 证书

使用 Let's Encrypt 免费证书：

```bash
# 安装 certbot
sudo yum install certbot python3-certbot-nginx  # CentOS
sudo apt-get install certbot python3-certbot-nginx  # Ubuntu

# 申请证书
sudo certbot --nginx -d your_domain.com

# 自动续期
sudo certbot renew --dry-run
```

#### 3.2 配置 HTTPS

Certbot 会自动修改 Nginx 配置，或手动修改：

```nginx
server {
    listen 80;
    server_name your_domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your_domain.com;

    ssl_certificate /etc/letsencrypt/live/your_domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your_domain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ... 其他配置同上
}
```

---

## Docker部署

### 1. 准备 Dockerfile

#### 1.1 后端 Dockerfile

创建 `backend/Dockerfile`：

```dockerfile
FROM openjdk:8-jdk-alpine

LABEL maintainer="base-system"

# 设置工作目录
WORKDIR /app

# 复制 jar 包
COPY target/base-backend-1.0.0.jar app.jar

# 设置时区
RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    apk del tzdata

# 暴露端口
EXPOSE 8080

# 启动命令
ENTRYPOINT ["java", "-jar", "-Xms512m", "-Xmx2g", "-Dspring.profiles.active=prod", "app.jar"]
```

#### 1.2 前端 Dockerfile

创建 `frontend/Dockerfile`：

```dockerfile
# 构建阶段
FROM node:16-alpine as builder

WORKDIR /app

# 复制 package.json 和 package-lock.json
COPY package*.json ./

# 安装依赖
RUN npm install --registry=https://registry.npmmirror.com

# 复制源代码
COPY . .

# 构建生产包
RUN npm run build

# 生产阶段
FROM nginx:alpine

# 复制构建文件到 Nginx
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动 Nginx
CMD ["nginx", "-g", "daemon off;"]
```

创建 `frontend/nginx.conf`：

```nginx
server {
    listen 80;
    server_name localhost;

    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://backend:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

### 2. Docker Compose 部署

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: base-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: base_system
      MYSQL_USER: base_user
      MYSQL_PASSWORD: base_password
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./backend/src/main/resources/db:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - base-network

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: base-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes --requirepass redis_password
    networks:
      - base-network

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: base-backend
    restart: always
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/base_system?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: base_user
      SPRING_DATASOURCE_PASSWORD: base_password
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PASSWORD: redis_password
    volumes:
      - ./data/upload:/data/upload
      - ./logs/backend:/var/log/base-system
    depends_on:
      - mysql
      - redis
    networks:
      - base-network

  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: base-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - base-network

networks:
  base-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  upload-data:
```

### 3. 启动 Docker 容器

```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose stop

# 停止并删除容器
docker-compose down

# 重启服务
docker-compose restart
```

### 4. Docker 常用命令

```bash
# 查看运行中的容器
docker ps

# 查看所有容器
docker ps -a

# 查看容器日志
docker logs -f base-backend

# 进入容器
docker exec -it base-backend sh

# 停止容器
docker stop base-backend

# 启动容器
docker start base-backend

# 删除容器
docker rm base-backend

# 查看镜像
docker images

# 删除镜像
docker rmi image_name
```

---

## 常见问题

### 1. 数据库相关

**Q: 数据库连接失败？**

A: 检查以下几点：
1. MySQL 服务是否启动：`systemctl status mysqld`
2. 数据库配置是否正确（地址、端口、用户名、密码）
3. 防火墙是否开放 3306 端口
4. MySQL 用户是否有远程访问权限

```sql
-- 授予远程访问权限
GRANT ALL PRIVILEGES ON base_system.* TO 'base_user'@'%' IDENTIFIED BY 'password';
FLUSH PRIVILEGES;
```

**Q: 数据库初始化失败？**

A:
1. 检查 SQL 脚本是否有语法错误
2. 检查数据库字符集是否为 utf8mb4
3. 手动执行 SQL 脚本查看具体错误信息

### 2. Redis 相关

**Q: Redis 连接失败？**

A: 检查以下几点：
1. Redis 服务是否启动：`systemctl status redis`
2. Redis 配置是否正确（地址、端口、密码）
3. 防火墙是否开放 6379 端口
4. Redis 是否设置了密码

```bash
# 测试 Redis 连接
redis-cli -h localhost -p 6379 -a password ping
```

### 3. 后端服务相关

**Q: 后端服务启动失败？**

A: 查看日志文件或控制台输出，常见原因：
1. 端口被占用：修改配置文件中的端口
2. 数据库连接失败：检查数据库配置
3. Redis 连接失败：检查 Redis 配置
4. 内存不足：增加 JVM 内存参数

```bash
# 查看端口占用
netstat -tunlp | grep 8080

# 杀死占用端口的进程
kill -9 pid
```

**Q: 接口返回 500 错误？**

A:
1. 查看后端日志文件
2. 检查数据库表结构是否正确
3. 检查 Redis 是否正常
4. 检查代码逻辑是否有异常

### 4. 前端服务相关

**Q: 前端页面无法访问？**

A: 检查以下几点：
1. Nginx 服务是否启动：`systemctl status nginx`
2. 静态文件是否正确部署
3. Nginx 配置是否正确
4. 防火墙是否开放 80/443 端口

```bash
# 测试 Nginx 配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```

**Q: 前端调用后端接口失败？**

A:
1. 检查 Nginx 代理配置是否正确
2. 检查后端服务是否正常运行
3. 检查浏览器控制台的网络请求
4. 检查跨域配置

### 5. Docker 相关

**Q: Docker 容器启动失败？**

A:
1. 查看容器日志：`docker logs container_name`
2. 检查 docker-compose.yml 配置
3. 检查镜像是否构建成功
4. 检查端口是否被占用

**Q: Docker 容器无法访问外部网络？**

A:
1. 检查 Docker 网络配置
2. 检查防火墙规则
3. 重启 Docker 服务：`systemctl restart docker`

### 6. 性能优化

**Q: 系统响应慢？**

A: 优化建议：
1. 增加服务器内存和 CPU
2. 优化数据库索引
3. 启用 Redis 缓存
4. 启用 Nginx Gzip 压缩
5. 使用 CDN 加速静态资源
6. 定期清理日志文件

**Q: 数据库查询慢？**

A:
1. 添加合适的索引
2. 优化 SQL 查询语句
3. 使用 Redis 缓存热点数据
4. 定期清理过期数据

### 7. 安全相关

**Q: 如何加强系统安全？**

A: 安全建议：
1. 修改默认密码（数据库、Redis、管理员账号）
2. 配置 HTTPS
3. 配置防火墙规则
4. 定期更新系统和软件
5. 启用日志审计
6. 限制 API 访问频率
7. 定期备份数据

---

## 附录

### A. 端口说明

| 服务 | 默认端口 | 说明 |
|------|---------|------|
| 后端服务 | 8080 | Spring Boot 应用端口 |
| 前端服务 | 3000 | Vite 开发服务器端口 |
| MySQL | 3306 | 数据库端口 |
| Redis | 6379 | 缓存端口 |
| Nginx | 80/443 | Web 服务器端口 |

### B. 目录结构

```
/opt/base-system/
├── backend/
│   ├── base-backend-1.0.0.jar
│   └── application-prod.yml
├── frontend/
│   └── dist/
│       ├── index.html
│       ├── assets/
│       └── ...
├── data/
│   ├── mysql/
│   ├── redis/
│   └── upload/
└── logs/
    ├── backend/
    └── nginx/
```

### C. 备份与恢复

**数据库备份：**

```bash
# 备份数据库
mysqldump -u root -p base_system > backup_$(date +%Y%m%d).sql

# 恢复数据库
mysql -u root -p base_system < backup_20260115.sql
```

**文件备份：**

```bash
# 备份上传文件
tar -czf upload_backup_$(date +%Y%m%d).tar.gz /data/upload/

# 恢复上传文件
tar -xzf upload_backup_20260115.tar.gz -C /data/
```

### D. 监控与维护

**系统监控：**
- 使用系统自带的"服务器监控"和"缓存监控"功能
- 配置 Prometheus + Grafana 进行更详细的监控

**日志管理：**
```bash
# 查看后端日志
tail -f /var/log/base-system/app.log

# 查看 Nginx 日志
tail -f /var/log/nginx/base-system-access.log
tail -f /var/log/nginx/base-system-error.log

# 清理过期日志
find /var/log/base-system/ -name "*.log.*" -mtime +30 -delete
```

**定期维护：**
1. 每周备份数据库
2. 每月清理过期日志
3. 每季度更新系统和软件
4. 定期检查磁盘空间

---

**文档版本：** v1.0.0
**最后更新：** 2026-01-15
**维护团队：** Base System Team
